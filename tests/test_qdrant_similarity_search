from __future__ import annotations

import os
from typing import Generator

import pytest
from fastapi.testclient import TestClient
from qdrant_client import QdrantClient
from sqlalchemy import create_engine
from sqlalchemy.orm import Session, sessionmaker
from sqlalchemy.pool import StaticPool

from app.core.config import settings
from app.db.base import Base
from app.db.session import get_db
from app.main import create_app
from app.integrations.vector.embedder import SentenceTransformerEmbedder


def _qdrant_tests_enabled() -> bool:
    return os.getenv('RUN_QDRANT_TESTS', 'false').lower() in ('1', 'true', 'yes')


pytestmark = pytest.mark.skipif(
    not _qdrant_tests_enabled(),
    reason='Set RUN_QDRANT_TESTS=true to run Qdrant similarity tests',
)


@pytest.fixture()
def app_client() -> Generator[TestClient, None, None]:
    engine = create_engine(
        'sqlite+pysqlite:///:memory:',
        connect_args={'check_same_thread': False},
        poolclass=StaticPool,
    )
    TestingSessionLocal = sessionmaker(bind=engine, autoflush=False, autocommit=False)
    Base.metadata.create_all(bind=engine)

    def override_get_db() -> Generator[Session, None, None]:
        db = TestingSessionLocal()
        try:
            yield db
        finally:
            db.close()

    app = create_app()
    app.dependency_overrides[get_db] = override_get_db

    with TestClient(app) as c:
        yield c

    app.dependency_overrides.clear()


def build_search_text(
    type_: str | None = None,
    key: str | None = None,
    value: dict | None = None,
) -> str:
    """
    I build the same kind of text we used while embedding memories.
    Any of the fields can be empty.
    """
    parts: list[str] = []
    if type_:
        parts.append(type_)
    if key:
        parts.append(key)
    if value:
        parts.append(str(value))
    return '\n'.join(parts)


def test_qdrant_similarity_search_partial_fields(app_client: TestClient) -> None:
    embedder = SentenceTransformerEmbedder()
    qc = QdrantClient(url=settings.qdrant_url)

    # --- create memories ---
    memories = [
        {
            'type': 'preference',
            'scope': 'profile',
            'key': 'response_verbosity',
            'value': {'style': 'concise'},
            'confidence': 0.95,
        },
        {
            'type': 'preference',
            'scope': 'profile',
            'key': 'code_style',
            'value': {'quotes': 'single'},
            'confidence': 0.95,
        },
        {
            'type': 'fact',
            'scope': 'profile',
            'key': 'user_name',
            'value': {'name': 'Rishi'},
            'confidence': 0.9,
        },
    ]

    for m in memories:
        r = app_client.post('/v1/memories', json=m)
        assert r.status_code == 200, r.text

    # --- search by key + value (no type) ---
    query_text = build_search_text(
        key='response verbosity',
        value={'concise': True},
    )
    vector = embedder.embed(query_text)

    results = qc.search(
        collection_name=settings.qdrant_collection,
        query_vector=vector,
        limit=3,
    )

    assert any(
        r.payload.get('key') == 'response_verbosity'
        for r in results
    )

    # --- search by type only ---
    query_text = build_search_text(type_='fact')
    vector = embedder.embed(query_text)

    results = qc.search(
        collection_name=settings.qdrant_collection,
        query_vector=vector,
        limit=3,
    )

    assert any(
        r.payload.get('type') == 'fact'
        for r in results
    )

    # --- search by value only ---
    query_text = build_search_text(value={'single quotes': True})
    vector = embedder.embed(query_text)

    results = qc.search(
        collection_name=settings.qdrant_collection,
        query_vector=vector,
        limit=3,
    )

    assert any(
        r.payload.get('key') == 'code_style'
        for r in results
    )
